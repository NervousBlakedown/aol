{% extends 'base.html' %}

{% block title %}Reset Password{% endblock %}

{% block content %}
<div class="container">
    <h2>Reset Your Password</h2>
    <p>Enter your new password below to reset your account password.</p>
    <form id="reset-password-form">
        <input type="password" id="new-password" name="new_password" placeholder="Enter new password" required>
        <input type="password" id="confirm-password" placeholder="Confirm new password" required>
        <button type="submit">Reset Password</button>
    </form>
    <div id="message" style="margin-top: 10px; color: red;"></div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const form = document.getElementById('reset-password-form');
    const messageDiv = document.getElementById('message');

    // Extract token from the URL
    const urlParams = new URLSearchParams(window.location.search);
    const resetToken = urlParams.get('token');

    if (!resetToken) {
        messageDiv.textContent = "Invalid or missing reset token.";
        return;
    }

    // Handle form submission
    form.addEventListener('submit', async (e) => {
        e.preventDefault();

        const newPassword = document.getElementById('new-password').value.trim();
        const confirmPassword = document.getElementById('confirm-password').value.trim();

        if (!newPassword || !confirmPassword) {
            messageDiv.textContent = "Please fill out both fields.";
            return;
        }

        if (newPassword !== confirmPassword) {
            messageDiv.textContent = "Passwords do not match.";
            return;
        }

        try {
            // Send new password and token to Flask backend
            const response = await fetch(`/update_password?token=${resetToken}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ new_password: newPassword })
            });

            const data = await response.json();
            if (data.success) {
                messageDiv.style.color = "green";
                messageDiv.textContent = "Password reset successfully! You can now log in.";
                setTimeout(() => window.location.href = "/login", 2000); // Redirect to login page
            } else {
                messageDiv.style.color = "red";
                messageDiv.textContent = data.message || "Failed to reset password.";
            }
        } catch (error) {
            console.error("Error:", error);
            messageDiv.textContent = "An unexpected error occurred. Please try again.";
        }
    });
});
</script>
{% endblock %}

{% extends 'base.html' %}

{% block title %}Dashboard - BlakeIM{% endblock %}

{% block content %}
<div id="dashboard" class="dashboard-layout">
    <!-- Top Bar -->
    <header class="dashboard-topbar">
        <div class="topbar-left">
            <h1 class="dashboard-logo">BlakeIM</h1>
        </div>
        <div class="topbar-center">
            <input type="text" id="global-search" placeholder="Search chats, topics, or Pals...">
        </div>
        <div class="topbar-right">
            <span>Welcome, <span id="username-display">{{ username }}</span></span>
            <button id="logout-button" class="logout-btn">Logout</button>
        </div>
    </header>

    <div class="dashboard-content">
        <!-- Left Sidebar -->
        <aside class="dashboard-sidebar">
            <div class="user-info">
                <h3>Your Info</h3>
                <p>Status: <select id="status" onchange="updateStatus(this.value)">
                    <option value="Online">Online</option>
                    <option value="Away">Away</option>
                    <option value="Do Not Disturb">Do Not Disturb</option>
                </select></p>

                <h3>Your Pals</h3>
                <ul id="contacts-list" class="contacts-list"></ul>
                <button id="start-chat-button" class="start-chat-btn">Start Chat</button>

                <h3>Add Pals</h3>
                <input type="text" id="search-input" placeholder="Search users...">
                <ul id="search-results" class="search-results"></ul>
            </div>
        </aside>

        <!-- Middle Section -->
        <main class="dashboard-main">
            <section class="active-chats">
                <h3>Active Chats</h3>
                <div id="chats-container" class="chats-container"></div>
            </section>
        </main>

        <!-- Right Sidebar -->
        <aside class="dashboard-topics">
            <section class="topic-chats">
                <h3>Topic Chats</h3>
                <div id="topic-chats-container" class="topic-chats-container"></div>
            </section>
        </aside>
    </div>
</div>

<style>
    /* General Layout */
    .dashboard-layout {
        display: grid;
        grid-template-rows: auto 1fr;
        grid-template-columns: 300px auto 300px;
        gap: 20px;
        height: 100vh;
        background: linear-gradient(135deg, #001f4d, #003b73);
        color: #333;
    }

    .dashboard-topbar {
        grid-column: 1 / 4;
        display: flex;
        align-items: center;
        justify-content: space-between;
        background-color: #0045ad;
        color: white;
        padding: 10px 20px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .dashboard-sidebar,
    .dashboard-main,
    .dashboard-topics {
        background-color: #ffffff;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        overflow-y: auto;
    }

    .dashboard-sidebar h3,
    .dashboard-main h3,
    .dashboard-topics h3 {
        font-size: 18px;
        color: #0045ad;
        margin-bottom: 10px;
    }

    /* Active Chats and Topics */
    .chats-container,
    .topic-chats-container {
        max-height: 80vh;
        overflow-y: auto;
        padding: 10px;
        background-color: #f4f4f4;
        border-radius: 8px;
        box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .chats-container div,
    .topic-chats-container div {
        padding: 10px;
        border-bottom: 1px solid #ddd;
    }

    .chats-container div:last-child,
    .topic-chats-container div:last-child {
        border-bottom: none;
    }

    /* Responsive Design */
    @media (max-width: 1024px) {
        .dashboard-layout {
            grid-template-columns: 1fr;
            grid-template-rows: auto auto auto auto;
        }

        .dashboard-topbar {
            grid-column: 1 / 2;
        }

        .dashboard-sidebar,
        .dashboard-main,
        .dashboard-topics {
            grid-column: 1 / 2;
        }
    }
</style>

<script>
  document.addEventListener('DOMContentLoaded', () => {
      // Function to populate Pals list with Remove buttons
      function updateContactsList() {
          const contactsList = document.getElementById('contacts-list');
          contactsList.innerHTML = ''; // Clear existing list

          myContacts.forEach(contact => {
              const listItem = document.createElement('li');
              listItem.innerHTML = `
                  <span>${contact.username} (${userStatuses[contact.username] || 'Offline'})</span>
                  <button class="remove-pal-btn" data-username="${contact.username}">Remove</button>
              `;
              contactsList.appendChild(listItem);
          });
      }

      // Handle Remove Pal button click
      document.addEventListener('click', (event) => {
          if (event.target.classList.contains('remove-pal-btn')) {
              const username = event.target.getAttribute('data-username');
              if (confirm(`Are you sure you want to remove ${username} from your Pals list?`)) {
                  removePal(username);
              }
          }
      });

      // Remove Pal API call
      function removePal(username) {
          fetch('/remove_contact', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ username }),
              credentials: 'include'
          })
              .then(response => response.json())
              .then(data => {
                  if (data.success) {
                      alert(`${username} has been removed from your Pals list.`);
                      fetchMyContacts(); // Refresh the Pals list
                  } else {
                      alert(data.message || 'Failed to remove Pal.');
                  }
              })
              .catch(error => console.error('Error removing Pal:', error));
      }
  });
</script>
{% endblock %}
